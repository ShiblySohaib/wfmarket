{% extends 'base.html' %}

{% block title %}Market - Warframe Market Manager{% endblock %}

{% block page_title %}Market{% endblock %}

{% block content %}
<div class="market-section">
    <div class="section-header">
        <div class="stats-container">
            <div class="market-info-card">
                <i class="fas fa-chart-line market-icon"></i>
                <div class="market-stats">
                    <span class="stats-label">Active Orders</span>
                    <span class="stats-count" id="activeOrdersCount">-</span>
                </div>
            </div>
            <div class="failed-info-card" id="failedCard" style="display: none;">
                <i class="fas fa-exclamation-triangle failed-icon"></i>
                <div class="failed-stats">
                    <span class="stats-label">Failed Items</span>
                    <span class="stats-count" id="failedItemsCount">0</span>
                </div>
            </div>
        </div>
        <div class="progress-card" id="progressCard">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
        <div class="refresh-card" id="refreshCard" style="display: none;">
            <div class="refresh-container">
                <div class="last-updated" id="lastUpdated">Last updated: Just now</div>
                <button class="btn btn-refresh" onclick="refreshMarketData()" title="Refresh market data">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
    
    {% if not has_items %}
        <div class="empty-state">
            <p>No items in inventory to check market data for.</p>
        </div>
    {% else %}
        <div class="loading-state" id="loadingState">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <p>Fetching market data for {{ total_items }} items...</p>
        </div>
        
        <div class="table-container" id="tableContainer" style="display: none;">
            <table class="market-table" id="marketTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Source</th>
                        <th>Qty</th>
                        <th>Buyer</th>
                        <th>Platinum</th>
                        <th>Order Qty</th>
                        <th>Rank</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="marketTableBody">
                    <!-- Market data will be populated here -->
                </tbody>
            </table>
        </div>
        <div class="table-footer" id="tableFooter" style="display: none;">
            <p id="resultsText">Loading market data...</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.market-section {
    margin: 0;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--accent-blue);
}

.stats-container {
    display: flex;
    align-items: center;
    gap: 20px;
}

.market-info-card, .failed-info-card {
    display: flex;
    align-items: center;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px 20px;
    gap: 15px;
}

.market-icon {
    font-size: 1.3rem;
    color: var(--accent-blue);
}

.failed-icon {
    font-size: 1.3rem;
    color: var(--error);
}

.market-stats, .failed-stats {
    display: flex;
    align-items: center;
    gap: 8px;
}

.stats-label {
    color: var(--text-secondary);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 500;
}

.stats-count {
    color: var(--accent-blue);
    font-size: 1.4rem;
    font-weight: bold;
    line-height: 1;
}

.failed-info-card .stats-count {
    color: var(--error);
}

.progress-card {
    display: flex;
    align-items: center;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px 20px;
    height: 53px; /* Match stats card height */
}

.progress-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 150px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-blue), #00b8e6);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 3px;
}

.progress-text {
    color: var(--text-primary);
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 40px;
    text-align: center;
}

.refresh-card {
    display: flex;
    align-items: center;
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px 20px;
    height: 53px; /* Match stats card height */
    gap: 15px;
}

.refresh-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.last-updated {
    color: var(--text-secondary);
    font-size: 0.85rem;
    white-space: nowrap;
}

.btn-refresh {
    background-color: var(--accent-blue);
    color: var(--bg-primary);
    padding: 8px 12px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.btn-refresh:hover {
    background-color: #0099cc;
}

.btn-refresh:active {
    background-color: #007399;
    transform: scale(0.98);
}

.btn-refresh:disabled {
    background-color: var(--bg-tertiary);
    color: var(--text-muted);
    cursor: not-allowed;
}

.btn-refresh i {
    color: inherit;
    font-size: 0.8rem;
}

.btn-refresh.refreshing i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.loading-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.loading-spinner {
    font-size: 2rem;
    color: var(--accent-blue);
    margin-bottom: 20px;
}

.loading-state p {
    margin: 10px 0;
    font-size: 1.1rem;
}

.table-container {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.market-table {
    width: 100%;
    border-collapse: collapse;
}

.market-table th {
    background-color: var(--bg-tertiary);
    color: var(--text-primary);
    padding: 15px 12px;
    text-align: center;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--border-color);
}

.market-table th:first-child {
    text-align: left;
}

.market-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
    text-align: center;
    font-size: 0.9rem;
}

.market-table td:first-child {
    text-align: left;
}

.market-row {
    transition: background-color 0.2s ease;
}

.market-row:hover {
    background-color: var(--hover-color);
}

.market-row:last-child td {
    border-bottom: none;
}

.market-item {
    color: var(--accent-blue) !important;
    font-weight: 500;
    max-width: 200px;
    word-wrap: break-word;
}

.market-category {
    color: var(--text-primary) !important;
}

.market-source {
    color: var(--text-primary) !important;
}

.market-inventory-qty {
    color: var(--accent-gold) !important;
    font-weight: 600;
}

.market-buyer {
    color: var(--text-primary) !important;
    font-weight: 500;
}

.reputation {
    color: var(--text-muted) !important;
    font-size: 0.8rem;
    font-weight: normal;
}

.market-platinum {
    color: #e6e6e6 !important;
    font-weight: bold;
    font-size: 1rem;
}

.market-order-qty {
    color: var(--accent-gold) !important;
    font-weight: 600;
}

.market-rank {
    color: var(--text-secondary) !important;
}

.market-actions {
    text-align: center;
    white-space: nowrap;
}

.btn-whisper {
    background-color: #4caf50;
    color: white;
    padding: 6px 12px;
    font-size: 0.85rem;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-whisper:hover {
    background-color: #45a049;
}

.btn-whisper:active {
    background-color: #3d8b40;
    transform: scale(0.98);
}

.btn-whisper i {
    color: white;
    font-size: 0.8rem;
}

.table-footer {
    margin-top: 15px;
    text-align: center;
}

.table-footer p {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin: 5px 0;
}

.failed-notice {
    color: var(--error) !important;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state p {
    margin: 10px 0;
    font-size: 1.1rem;
}

@media (max-width: 1200px) {
    .market-table {
        font-size: 0.85rem;
    }
    
    .market-table th,
    .market-table td {
        padding: 10px 8px;
    }
}

@media (max-width: 768px) {
    .table-container {
        overflow-x: auto;
    }
    
    .market-table {
        min-width: 900px;
    }
    
    .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
}

/* Whisper copied notification */
.whisper-copied {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: var(--accent-blue);
    color: var(--bg-primary);
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Market data fetching and progress tracking
let lastFetchTime = null;
let currentMarketData = [];
let updateTimeInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    const hasItems = {{ has_items|yesno:"true,false" }};
    
    if (hasItems) {
        fetchMarketData();
    }
});

function fetchMarketData() {
    const progressCard = document.getElementById('progressCard');
    const refreshCard = document.getElementById('refreshCard');
    const refreshBtn = document.querySelector('.btn-refresh');
    const refreshIcon = document.getElementById('refreshIcon');
    
    // Show progress card, hide refresh card
    progressCard.style.display = 'flex';
    refreshCard.style.display = 'none';
    
    // Disable refresh button if it exists
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.classList.add('refreshing');
    }
    
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const activeOrdersCount = document.getElementById('activeOrdersCount');
    const failedItemsCount = document.getElementById('failedItemsCount');
    const failedCard = document.getElementById('failedCard');
    const loadingState = document.getElementById('loadingState');
    const tableContainer = document.getElementById('tableContainer');
    const tableFooter = document.getElementById('tableFooter');
    const resultsText = document.getElementById('resultsText');
    
    // Start progress animation
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        if (progress >= 95) {
            clearInterval(progressInterval);
            progress = 95;
        }
        updateProgress(progress);
    }, 100);
    
    function updateProgress(value) {
        progressFill.style.width = value + '%';
        progressText.textContent = Math.round(value) + '%';
    }
    
    // Fetch market data
    fetch('/market/fetch-data/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        updateProgress(100);
        
        // Check if data has changed
        const dataChanged = hasDataChanged(data.market_data);
        
        if (dataChanged || currentMarketData.length === 0) {
            // Update stats
            activeOrdersCount.textContent = data.total_orders;
            failedItemsCount.textContent = data.total_failed;
            
            if (data.total_failed > 0) {
                failedCard.style.display = 'flex';
            } else {
                failedCard.style.display = 'none';
            }
            
            // Hide loading state if first load
            if (loadingState) {
                loadingState.style.display = 'none';
            }
            
            if (data.market_data.length > 0) {
                // Update table
                populateTable(data.market_data);
                tableContainer.style.display = 'block';
                tableFooter.style.display = 'block';
                
                resultsText.innerHTML = `Showing ${data.total_orders} buy orders from online players`;
                if (data.total_failed > 0) {
                    resultsText.innerHTML += `<br><span class="failed-notice">${data.total_failed} items failed to load market data</span>`;
                }
            } else if (currentMarketData.length === 0) {
                // Show empty state only on first load
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                    <p>No market data available.</p>
                    <p>Make sure you have items in your inventory and try refreshing the page.</p>
                `;
                document.querySelector('.market-section').appendChild(emptyState);
            }
            
            // Store current data
            currentMarketData = data.market_data;
            lastFetchTime = new Date();
        }
        
        // Show refresh card and hide progress card
        setTimeout(() => {
            progressCard.style.display = 'none';
            refreshCard.style.display = 'flex';
            
            // Enable refresh button
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('refreshing');
            }
            
            // Start time update interval
            updateLastUpdatedTime();
            startTimeUpdateInterval();
        }, 1000);
    })
    .catch(error => {
        console.error('Error fetching market data:', error);
        clearInterval(progressInterval);
        
        if (loadingState) {
            loadingState.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
                </div>
                <p style="color: var(--error);">Failed to load market data. Please try refreshing the page.</p>
            `;
        }
        
        // Show refresh card
        progressCard.style.display = 'none';
        refreshCard.style.display = 'flex';
        
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('refreshing');
        }
    });
}

function refreshMarketData() {
    fetchMarketData();
}

function hasDataChanged(newData) {
    if (currentMarketData.length !== newData.length) {
        return true;
    }
    
    // Simple comparison - in production you might want more sophisticated comparison
    const currentStr = JSON.stringify(currentMarketData.map(item => ({
        item: item.item,
        buyer: item.buyer,
        platinum: item.platinum,
        order_quantity: item.order_quantity
    })));
    
    const newStr = JSON.stringify(newData.map(item => ({
        item: item.item,
        buyer: item.buyer,
        platinum: item.platinum,
        order_quantity: item.order_quantity
    })));
    
    return currentStr !== newStr;
}

function updateLastUpdatedTime() {
    if (!lastFetchTime) return;
    
    const now = new Date();
    const diff = Math.floor((now - lastFetchTime) / 1000); // seconds
    const lastUpdatedElement = document.getElementById('lastUpdated');
    
    if (!lastUpdatedElement) return;
    
    let timeText;
    let nextUpdateIn; // seconds until next update needed
    
    if (diff < 60) {
        timeText = 'Just now';
        nextUpdateIn = 60 - diff;
    } else if (diff < 3600) {
        const minutes = Math.floor(diff / 60);
        timeText = `${minutes}m ago`;
        nextUpdateIn = 60 - (diff % 60);
    } else {
        const hours = Math.floor(diff / 3600);
        timeText = `${hours}h ago`;
        nextUpdateIn = 3600 - (diff % 3600);
    }
    
    lastUpdatedElement.textContent = `Last updated: ${timeText}`;
    return nextUpdateIn;
}

function startTimeUpdateInterval() {
    if (updateTimeInterval) {
        clearInterval(updateTimeInterval);
    }
    
    function scheduleNextUpdate() {
        const nextUpdateIn = updateLastUpdatedTime();
        if (nextUpdateIn) {
            updateTimeInterval = setTimeout(() => {
                updateLastUpdatedTime();
                scheduleNextUpdate();
            }, nextUpdateIn * 1000);
        }
    }
    
    scheduleNextUpdate();
}

function populateTable(marketData) {
    const tbody = document.getElementById('marketTableBody');
    tbody.innerHTML = '';
    
    marketData.forEach(order => {
        const row = document.createElement('tr');
        row.className = 'market-row';
        
        const rankText = order.rank > 0 ? `Rank ${order.rank}` : 'Unranked';
        
        row.innerHTML = `
            <td class="market-item">${order.item}</td>
            <td class="market-category">${order.category.charAt(0).toUpperCase() + order.category.slice(1)}</td>
            <td class="market-source">${order.source.charAt(0).toUpperCase() + order.source.slice(1)}</td>
            <td class="market-inventory-qty">${order.inventory_quantity}</td>
            <td class="market-buyer">
                ${order.buyer}
                <span class="reputation" title="Reputation: ${order.user_reputation}">
                    (${order.user_reputation})
                </span>
            </td>
            <td class="market-platinum">${order.platinum}</td>
            <td class="market-order-qty">${order.order_quantity}</td>
            <td class="market-rank">${rankText}</td>
            <td class="market-actions">
                <button class="btn btn-whisper" onclick="copyWhisper('${order.buyer}', '${order.item}', ${order.platinum}, ${order.order_quantity})" title="Copy whisper message">
                    <i class="fas fa-comment"></i>
                    Whisper
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function copyWhisper(buyer, itemName, platinum, quantity) {
    // Format the whisper message according to Warframe Market standards
    const whisperMessage = `/w ${buyer} Hi! I want to buy: ${itemName} for ${platinum} platinum. (warframe.market)`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(whisperMessage).then(function() {
        // Show success notification
        showNotification('Whisper message copied to clipboard!');
    }, function(err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = whisperMessage;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Whisper message copied to clipboard!');
    });
}

function showNotification(message) {
    // Remove existing notification if any
    const existing = document.querySelector('.whisper-copied');
    if (existing) {
        existing.remove();
    }
    
    // Create new notification
    const notification = document.createElement('div');
    notification.className = 'whisper-copied';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remove after animation
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (updateTimeInterval) {
        clearInterval(updateTimeInterval);
    }
});
</script>
{% endblock %}
